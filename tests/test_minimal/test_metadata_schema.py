import traceback
import unittest
from pathlib import Path

import jsonschema
import pytest

from neuroconv.utils import load_dict_from_file
from neuroconv.utils.json_schema import validate_metadata


def test_metadata_schema():
    metadata_schema = load_dict_from_file(
        Path(__file__).parent.parent.parent / "src" / "neuroconv" / "schemas" / "metadata_schema.json"
    )

    metadata = dict(
        NWBFile=dict(
            session_start_time="2020-01-01T00:00:00",
            session_description="Auto-generated by neuroconv",
            identifier="1234",
        ),
        Ophys=dict(
            Devices=[
                dict(
                    name="ImagingDevice",
                ),
            ],
            Fluorescence=dict(
                name="Fluorescence",
                PlaneSegmentationChan1Plane0=dict(
                    raw=dict(name="RoiResponseSeriesChan1Plane0", description="raw fluorescence signal"),
                    deconvolved=dict(name="DeconvolvedChan1Plane0", description="deconvolved fluorescence signal"),
                    neuropil=dict(name="NeuropilChan1Plane0", description="neuropil fluorescence signal"),
                ),
                PlaneSegmentationChan1Plane1=dict(
                    raw=dict(name="RoiResponseSeriesChan1Plane0", description="raw fluorescence signal"),
                    deconvolved=dict(name="DeconvolvedChan1Plane0", description="deconvolved fluorescence signal"),
                    neuropil=dict(name="NeuropilChan1Plane0", description="neuropil fluorescence signal"),
                ),
            ),
            DfOverF=dict(
                name="DfOverF",
                PlaneSegmentationChan1Plane0=dict(
                    dff=dict(name="RoiResponseSeriesChan1Plane0", description="Array of df/F traces."),
                ),
                PlaneSegmentationChan1Plane1=dict(
                    dff=dict(name="RoiResponseSeriesChan1Plane0", description="Array of df/F traces."),
                ),
            ),
            SegmentationImages=dict(
                name="SegmentationImages",
                PlaneSegmentationChan1Plane0=dict(
                    raw=dict(name="PlaneSegmentationChan1Plane0", description="raw segmentation image"),
                    neuropil=dict(name="PlaneSegmentationChan1Plane0", description="neuropil segmentation image"),
                ),
            ),
        ),
    )

    validate_metadata(metadata=metadata, schema=metadata_schema)


device_error = "'Devices' is a required property"
invalid_plane_name = "plane_segmentation_chan1_plane0"
name_error = "'name' is a required property"
description_error = "'description' is a required property"
plane_name_error = f"'{invalid_plane_name}' does not match any of the regexes"
not_enough_properties_error = "does not have enough properties"


def test_invalid_ophys_metadata():
    metadata_schema = load_dict_from_file(
        Path(__file__).parent.parent.parent / "src" / "neuroconv" / "schemas" / "metadata_schema.json"
    )

    def create_valid_plane_name(name: str, number=0):
        return f'{"".join(map(lambda str: str.capitalize(), name.split("_")))[:-1]}{str(number)}'

    metadata = dict(
        NWBFile=dict(
            session_start_time="2020-01-01T00:00:00",
            session_description="Auto-generated by neuroconv",
            identifier="1234",
        ),
        Ophys=dict(
            Fluorescence={
                "name": "Fluorescence",
                invalid_plane_name: dict(),  # Uncheked
                create_valid_plane_name(invalid_plane_name): dict(),
                create_valid_plane_name(invalid_plane_name, 1): dict(
                    raw=dict(),
                ),
            },
            DFOverF={
                "name": "DfOverF",
                invalid_plane_name: dict(),  # Uncheked
                create_valid_plane_name(invalid_plane_name): dict(),
                create_valid_plane_name(invalid_plane_name, 1): dict(
                    raw=dict(),
                ),
            },
            SegmentationImages={
                "name": "SegmentationImages",
                invalid_plane_name: dict(),  # Uncheked
                create_valid_plane_name(invalid_plane_name): dict(),
                create_valid_plane_name(invalid_plane_name, 1): dict(
                    raw=dict(),
                ),
            },
        ),
    )

    validator = jsonschema.Draft7Validator(metadata_schema)

    errors = list(map(lambda e: str(e).split("\n")[0], validator.iter_errors(metadata)))

    iterable = iter(errors)
    nExpectedErrors = 12
    assert len(errors) == nExpectedErrors

    assert device_error == next(iterable, None)

    # Fluorescence
    assert not_enough_properties_error in next(iterable, "")
    assert name_error == next(iterable, None)
    assert description_error == next(iterable, None)
    assert plane_name_error in next(iterable, "")

    # DfOverF
    assert not_enough_properties_error in next(iterable, "")
    assert name_error == next(iterable, None)
    assert description_error == next(iterable, None)
    assert plane_name_error in next(iterable, "")

    # SegmentationImages
    assert not_enough_properties_error in next(iterable, "")
    assert name_error == next(iterable, None)
    assert plane_name_error in next(iterable, "")


def test_invalid_ophys_plane_metadata():
    metadata_schema = load_dict_from_file(
        Path(__file__).parent.parent.parent / "src" / "neuroconv" / "schemas" / "metadata_schema.json"
    )

    def create_valid_plane_name(name: str, number=0):
        return f'{"".join(map(lambda str: str.capitalize(), name.split("_")))[:-1]}{str(number)}'

    valid_plane_name = create_valid_plane_name(invalid_plane_name)

    # Just a name is not enough
    metadata = dict(
        NWBFile=dict(
            session_start_time="2020-01-01T00:00:00",
            session_description="Auto-generated by neuroconv",
            identifier="1234",
        ),
        Ophys=dict(
            Fluorescence={"name": "Fluorescence"},
            DFOverF={"name": "DfOverF"},
            SegmentationImages={"name": "SegmentationImages"},
        ),
    )

    validator = jsonschema.Draft7Validator(metadata_schema)

    errors = list(map(lambda e: str(e).split("\n")[0], validator.iter_errors(metadata)))

    iterable = iter(errors)
    nExpectedErrors = 4
    assert len(errors) == nExpectedErrors

    assert device_error == next(iterable, None)

    # Fluorescence
    assert not_enough_properties_error in next(iterable, "")

    # DfOverF
    assert not_enough_properties_error in next(iterable, "")

    # SegmentationImages
    assert not_enough_properties_error in next(iterable, "")

    plane_update = {
        valid_plane_name: dict(
            raw=dict(name=valid_plane_name, description="basic description"),
        ),
    }

    # Adding a single plane removes the errors
    metadata["Ophys"]["Fluorescence"].update(plane_update)
    metadata["Ophys"]["DFOverF"].update(plane_update)
    metadata["Ophys"]["SegmentationImages"].update(plane_update)

    errors = list(map(lambda e: str(e).split("\n")[0], validator.iter_errors(metadata)))
    iterable = iter(errors)

    nExpectedErrors = 1
    assert len(errors) == nExpectedErrors
    assert device_error == next(iterable, None)
